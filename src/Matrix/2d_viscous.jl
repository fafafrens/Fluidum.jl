# the convention here are T, ux, uy, \[Pi]yy, \[Pi]zz, \[Pi]xy, \[Pi]B

@inbounds @fastmath function matrxi2d_visc!(A_i,Source,ϕ,t,X,params)
 

    therm=thermodynamic(ϕ[1],params)
        
    etaVisc=viscosity(ϕ[1],therm,params.shear)
    
    tauS=τ_shear(ϕ[1],therm,params.shear)
    
    tauB=τ_bulk(ϕ[1],therm,params.bulk)
    
    zeta=bulk_viscosity(ϕ[1],therm,params.bulk)
    
 
    (At,Ax, Ay, source)=two_d_viscous_matrix(ϕ,t,therm.pressure,therm.pressure_derivative[1],therm.pressure_hessian[1],zeta,etaVisc,tauS,tauB)
    

        
        Ainv= inv(At)

    
        A_mul_B!(A_i[1], Ainv,Ax)
        A_mul_B!(A_i[2], Ainv,Ay)
        
        jgemvavx!(Source, Ainv,source)
    
        
    
    end 



@inbounds @fastmath function two_d_viscous_matrix(u,tau,p,dtp,dtdtp,zeta,visc,tauS,tauB)
    
At=SMatrix{7,7}(

    dtp*(^(u[2],2) + ^(u[3],2)) + dtdtp*u[1]*(1 + ^(u[2],2) + ^(u[3],2))

    ,(dtp + dtdtp*u[1])*u[2]*sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,(dtp + dtdtp*u[1])*u[3]*sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,0

    ,0

    ,0

    ,0

    ,(2*(dtp*u[1]*u[2]*(1 + ^(u[3],2)) + u[3]*u[6] + u[2]*(u[7] + ^(u[3],2)*u[7] - u[4] - u[5])))/(1 + ^(u[3],2))

    ,(dtp*u[1]*(1 + ^(u[3],2))*(1 + ^(u[2],2) + ^(u[3],2))*(1 + 2*^(u[2],2) + ^(u[3],2)) + (1 + ^(u[3],2))*(1 + ^(u[2],2) + ^(u[3],2))*(1 + 2*^(u[2],2) + ^(u[3],2))*u[7] + 3*u[2]*u[3]*u[6] + 2*^(u[2],3)*u[3]*u[6] + 3*u[2]*^(u[3],3)*u[6] - u[4] - 3*^(u[2],2)*u[4] - 2*^(u[2],4)*u[4] - ^(u[3],2)*u[4] - 3*^(u[2],2)*^(u[3],2)*u[4] - (1 + ^(u[2],2) + ^(u[3],2))*(1 + 2*^(u[2],2) + ^(u[3],2))*u[5])/((1 + ^(u[3],2))*^(1 + ^(u[2],2) + ^(u[3],2),1.5))

    ,(u[6] + u[3]*(dtp*u[1]*u[2]*(1 + ^(u[2],2) + ^(u[3],2)) + ^(u[2],3)*u[7] + u[3]*u[6] + u[2]*(u[7] + ^(u[3],2)*u[7] - u[4])))/^(1 + ^(u[2],2) + ^(u[3],2),1.5)

    ,(-2*(1 + ^(u[3],2))*(u[2]*visc + 3*tauS*u[3]*u[6]) + 6*tauS*u[2]*^(u[3],2)*u[4])/(3*sqrt(1 + ^(u[2],2) + ^(u[3],2)))

    ,(-2*u[2]*visc)/(3*^(tau,2)*sqrt(1 + ^(u[2],2) + ^(u[3],2)))

    ,(-3*u[2]*(-1 + tauS*(2 + 4*^(u[3],2)))*u[6] + 3*(1 + 2*tauS)*u[3]*u[4] + 6*tauS*(u[3] + ^(u[3],3))*u[5] + 2*^(u[2],2)*u[3]*(-2*visc + 3*tauS*(2*u[4] + u[5])))/(6*sqrt(1 + ^(u[2],2) + ^(u[3],2)))

    ,(u[2]*zeta)/sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,(2*(u[2]*u[6] + u[3]*(dtp*u[1]*^(1 + ^(u[3],2),2) + ^(1 + ^(u[3],2),2)*u[7] + u[4] + u[2]*(-(u[3]*u[6]) + u[2]*(u[4] + u[5])))))/^(1 + ^(u[3],2),2)

    ,(dtp*u[1]*u[2]*u[3]*^(1 + ^(u[3],2),2)*(1 + ^(u[2],2) + ^(u[3],2)) - 2*^(u[2],4)*(-1 + ^(u[3],2))*u[6] + ^(1 + ^(u[3],2),2)*u[6] - 3*^(u[2],2)*(-1 + ^(u[3],4))*u[6] + 2*^(u[2],5)*u[3]*(u[4] + u[5]) + u[2]*u[3]*(1 + ^(u[3],2))*(^(1 + ^(u[3],2),2)*u[7] + 3*u[4] + u[5] + ^(u[3],2)*u[5]) + ^(u[2],3)*u[3]*(^(1 + ^(u[3],2),2)*u[7] + 5*u[4] + 3*u[5] + 3*^(u[3],2)*(u[4] + u[5])))/(^(1 + ^(u[3],2),2)*^(1 + ^(u[2],2) + ^(u[3],2),1.5))

    ,(dtp*u[1]*(1 + ^(u[2],2) + ^(u[3],2))*(1 + ^(u[2],2) + 2*^(u[3],2)) + (1 + ^(u[2],2) + ^(u[3],2))*(1 + ^(u[2],2) + 2*^(u[3],2))*u[7] - u[2]*u[3]*u[6] + u[4] + ^(u[2],2)*u[4])/^(1 + ^(u[2],2) + ^(u[3],2),1.5)

    ,(4*^(u[3],3)*visc + 3*u[2]*u[6] + 6*tauS*u[2]*^(u[3],2)*u[6] + u[3]*((4 + 6*^(u[2],2))*visc + 3*u[4] - 6*tauS*(1 + ^(u[2],2))*u[4]))/(3*sqrt(1 + ^(u[2],2) + ^(u[3],2)))

    ,(-2*u[3]*visc)/(3*^(tau,2)*sqrt(1 + ^(u[2],2) + ^(u[3],2)))

    ,(-3*(-1 + 2*tauS)*u[3]*(1 + ^(u[3],2))*u[6] + 6*^(u[2],2)*u[3]*(1 + 2*tauS*^(u[3],2))*u[6] - 3*^(u[2],3)*(-4*(1 + ^(u[3],2))*visc + u[4] + 2*tauS*u[4] + u[5] + 2*tauS*^(u[3],2)*(2*u[4] + u[5])) + u[2]*(4*(3 + 5*^(u[3],2) + 2*^(u[3],4))*visc - 3*(u[4] + 2*tauS*u[4] + u[5]) - 3*^(u[3],2)*(u[5] + 2*tauS*(2*u[4] + u[5] + ^(u[3],2)*u[5]))))/(6*(1 + ^(u[3],2))*sqrt(1 + ^(u[2],2) + ^(u[3],2)))

    ,(u[3]*zeta)/sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,(-^(u[2],2) + ^(u[3],2))/(1 + ^(u[3],2))

    ,-((u[2]*(1 + ^(u[2],2)))/((1 + ^(u[3],2))*sqrt(1 + ^(u[2],2) + ^(u[3],2))))

    ,u[3]/sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,tauS*sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,0

    ,0

    ,0

    ,-(^(u[2],2)/(1 + ^(u[3],2)))

    ,-((u[2]*sqrt(1 + ^(u[2],2) + ^(u[3],2)))/(1 + ^(u[3],2)))

    ,0

    ,0

    ,(tauS*sqrt(1 + ^(u[2],2) + ^(u[3],2)))/^(tau,2)

    ,0

    ,0

    ,(2*u[2]*u[3])/(1 + ^(u[3],2))

    ,(u[3] + 2*^(u[2],2)*u[3] + ^(u[3],3))/((1 + ^(u[3],2))*sqrt(1 + ^(u[2],2) + ^(u[3],2)))

    ,u[2]/sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,0

    ,0

    ,tauS*sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,0

    ,^(u[2],2) + ^(u[3],2)

    ,u[2]*sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,u[3]*sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,0

    ,0

    ,0

    ,tauB*sqrt(1 + ^(u[2],2) + ^(u[3],2))

)
    #########################################################################################################################################################################
    
Ax=SMatrix{7,7}(

    (dtp + dtdtp*u[1])*u[2]*sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,dtp + (dtp + dtdtp*u[1])*^(u[2],2)

    ,(dtp + dtdtp*u[1])*u[2]*u[3]

    ,0

    ,0

    ,0

    ,0

    ,(dtp*u[1]*(1 + ^(u[3],2))*(1 + ^(u[2],2) + ^(u[3],2))*(1 + 2*^(u[2],2) + ^(u[3],2)) + (1 + ^(u[3],2))*(1 + ^(u[2],2) + ^(u[3],2))*(1 + 2*^(u[2],2) + ^(u[3],2))*u[7] + 3*u[2]*u[3]*u[6] + 2*^(u[2],3)*u[3]*u[6] + 3*u[2]*^(u[3],3)*u[6] - u[4] - 3*^(u[2],2)*u[4] - 2*^(u[2],4)*u[4] - ^(u[3],2)*u[4] - 3*^(u[2],2)*^(u[3],2)*u[4] - (1 + ^(u[2],2) + ^(u[3],2))*(1 + 2*^(u[2],2) + ^(u[3],2))*u[5])/((1 + ^(u[3],2))*^(1 + ^(u[2],2) + ^(u[3],2),1.5))

    ,(2*(dtp*u[1]*u[2]*(1 + ^(u[3],2)) + u[3]*u[6] + u[2]*(u[7] + ^(u[3],2)*u[7] - u[4] - u[5])))/(1 + ^(u[3],2))

    ,u[3]*(dtp*u[1] + u[7])

    ,(-2*(1 + ^(u[3],2))*visc)/3. + (2*tauS*u[2]*u[3]*(-((1 + ^(u[3],2))*u[6]) + u[2]*u[3]*u[4]))/(1 + ^(u[2],2) + ^(u[3],2))

    ,(-2*visc)/(3*^(tau,2))

    ,(u[2]*(3*(1 - 2*tauS)*u[2]*u[6] - 12*tauS*u[2]*^(u[3],2)*u[6] + ^(u[3],3)*(-4*visc + 6*tauS*u[5]) + u[3]*(-4*(1 + ^(u[2],2))*visc + 3*(1 + 2*tauS)*u[4] + 6*tauS*(u[5] + ^(u[2],2)*(2*u[4] + u[5])))))/(6*(1 + ^(u[2],2) + ^(u[3],2)))

    ,zeta

    ,(dtp*u[1]*u[2]*u[3]*^(1 + ^(u[3],2),2)*(1 + ^(u[2],2) + ^(u[3],2)) - 2*^(u[2],4)*(-1 + ^(u[3],2))*u[6] + ^(1 + ^(u[3],2),2)*u[6] - 3*^(u[2],2)*(-1 + ^(u[3],4))*u[6] + 2*^(u[2],5)*u[3]*(u[4] + u[5]) + u[2]*u[3]*(1 + ^(u[3],2))*(^(1 + ^(u[3],2),2)*u[7] + 3*u[4] + u[5] + ^(u[3],2)*u[5]) + ^(u[2],3)*u[3]*(^(1 + ^(u[3],2),2)*u[7] + 5*u[4] + 3*u[5] + 3*^(u[3],2)*(u[4] + u[5])))/(^(1 + ^(u[3],2),2)*^(1 + ^(u[2],2) + ^(u[3],2),1.5))

    ,(2*(u[2]*(u[6] - ^(u[3],2)*u[6]) + u[3]*u[4] + ^(u[2],2)*u[3]*(u[4] + u[5])))/^(1 + ^(u[3],2),2)

    ,u[2]*(dtp*u[1] + u[7])

    ,u[6] + (2*u[2]*u[3]*((1 + ^(u[2],2) + ^(u[3],2))*visc + tauS*u[2]*u[3]*u[6]) - 2*tauS*(u[2] + ^(u[2],3))*u[3]*u[4])/(1 + ^(u[2],2) + ^(u[3],2))

    ,0

    ,-(-4*(1 + ^(u[2],2))*(1 + ^(u[3],2))*(1 + ^(u[2],2) + ^(u[3],2))*visc + (-3 + 2*tauS)*u[2]*u[3]*(1 + ^(u[3],2))*u[6] - 2*^(u[2],3)*u[3]*(1 + 2*tauS*^(u[3],2))*u[6] + (1 + ^(u[3],2))*(2*u[4] + u[5] + ^(u[3],2)*u[5]) + ^(u[2],4)*(u[4] + tauS*(2 + 4*^(u[3],2))*u[4] + u[5] + 2*tauS*^(u[3],2)*u[5]) + ^(u[2],2)*((3 + 2*tauS + 2*(1 + 2*tauS)*^(u[3],2))*u[4] + 2*(1 + ^(u[3],2))*(1 + tauS*^(u[3],2))*u[5]))/(2*(1 + ^(u[3],2))*(1 + ^(u[2],2) + ^(u[3],2)))

    ,0

    ,-((u[2]*(1 + ^(u[2],2)))/((1 + ^(u[3],2))*sqrt(1 + ^(u[2],2) + ^(u[3],2))))

    ,-((1 + ^(u[2],2))/(1 + ^(u[3],2)))

    ,0

    ,tauS*u[2]

    ,0

    ,0

    ,0

    ,-((u[2]*sqrt(1 + ^(u[2],2) + ^(u[3],2)))/(1 + ^(u[3],2)))

    ,-1 - ^(u[2],2)/(1 + ^(u[3],2))

    ,0

    ,0

    ,(tauS*u[2])/^(tau,2)

    ,0

    ,0

    ,(u[3] + 2*^(u[2],2)*u[3] + ^(u[3],3))/((1 + ^(u[3],2))*sqrt(1 + ^(u[2],2) + ^(u[3],2)))

    ,(2*u[2]*u[3])/(1 + ^(u[3],2))

    ,1

    ,0

    ,0

    ,tauS*u[2]

    ,0

    ,u[2]*sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,1 + ^(u[2],2)

    ,u[2]*u[3]

    ,0

    ,0

    ,0

    ,tauB*u[2]

)
    #########################################################################################################################################################################
Ay=SMatrix{7,7}(

    (dtp + dtdtp*u[1])*u[3]*sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,(dtp + dtdtp*u[1])*u[2]*u[3]

    ,dtp + (dtp + dtdtp*u[1])*^(u[3],2)

    ,0

    ,0

    ,0

    ,0

    ,(u[6] + u[3]*(dtp*u[1]*u[2]*(1 + ^(u[2],2) + ^(u[3],2)) + ^(u[2],3)*u[7] + u[3]*u[6] + u[2]*(u[7] + ^(u[3],2)*u[7] - u[4])))/^(1 + ^(u[2],2) + ^(u[3],2),1.5)

    ,u[3]*(dtp*u[1] + u[7])

    ,0

    ,-(((1 + 2*tauS*^(u[3],2))*(u[6] + ^(u[3],2)*u[6] - u[2]*u[3]*u[4]))/(1 + ^(u[2],2) + ^(u[3],2)))

    ,0

    ,(-(u[2]*u[3]*(1 + tauS*(2 + 4*^(u[3],2)))*u[6]) + 2*u[4] + u[5] + ^(u[2],2)*(1 + 2*tauS*^(u[3],2))*(2*u[4] + u[5]) + ^(u[3],2)*(u[4] + 2*tauS*u[4] + u[5] + 2*tauS*(1 + ^(u[3],2))*u[5]))/(2*(1 + ^(u[2],2) + ^(u[3],2)))

    ,0

    ,(dtp*u[1]*(1 + ^(u[2],2) + ^(u[3],2))*(1 + ^(u[2],2) + 2*^(u[3],2)) + (1 + ^(u[2],2) + ^(u[3],2))*(1 + ^(u[2],2) + 2*^(u[3],2))*u[7] - u[2]*u[3]*u[6] + u[4] + ^(u[2],2)*u[4])/^(1 + ^(u[2],2) + ^(u[3],2),1.5)

    ,u[2]*(dtp*u[1] + u[7])

    ,2*u[3]*(dtp*u[1] + u[7])

    ,(4*(1 + ^(u[3],2))*visc)/3. + (u[3]*(u[2]*(1 + 2*tauS*^(u[3],2))*u[6] + (1 - 2*tauS*(1 + ^(u[2],2)))*u[3]*u[4]))/(1 + ^(u[2],2) + ^(u[3],2))

    ,(-2*visc)/(3*^(tau,2))

    ,(u[3]*(-3*(-1 + 2*tauS)*u[3]*(1 + ^(u[3],2))*u[6] + 6*^(u[2],2)*u[3]*(1 + 2*tauS*^(u[3],2))*u[6] + ^(u[2],3)*(8*(1 + ^(u[3],2))*visc - 6*tauS*^(u[3],2)*(2*u[4] + u[5]) - 3*(u[4] + 2*tauS*u[4] + u[5])) + u[2]*(8*^(1 + ^(u[3],2),2)*visc - 3*(u[4] + tauS*(2 + 4*^(u[3],2))*u[4] + (1 + ^(u[3],2))*(1 + 2*tauS*^(u[3],2))*u[5]))))/(6*(1 + ^(u[3],2))*(1 + ^(u[2],2) + ^(u[3],2)))

    ,zeta

    ,u[3]/sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,0

    ,1

    ,tauS*u[3]

    ,0

    ,0

    ,0

    ,0

    ,0

    ,0

    ,0

    ,(tauS*u[3])/^(tau,2)

    ,0

    ,0

    ,u[2]/sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,1

    ,0

    ,0

    ,0

    ,tauS*u[3]

    ,0

    ,u[3]*sqrt(1 + ^(u[2],2) + ^(u[3],2))

    ,u[2]*u[3]

    ,1 + ^(u[3],2)

    ,0

    ,0

    ,0

    ,tauB*u[3]

)
    #########################################################################################################################################################


    #########################################################################################################################################################

source=SVector{7}(

    (dtp*u[1]*(1 + ^(u[3],2))*(1 + ^(u[2],2) + ^(u[3],2)) + u[7] + 2*u[2]*u[3]*u[6] + ^(u[2],2)*(u[7] + ^(u[3],2)*u[7] - u[4] - u[5]) + u[5] + ^(u[3],2)*((2 + ^(u[3],2))*u[7] + u[4] + u[5]))/(tau*(1 + ^(u[3],2)))

    ,(dtp*u[1]*u[2]*(1 + ^(u[3],2))*(1 + ^(u[2],2) + ^(u[3],2)) + 2*^(u[2],2)*u[3]*u[6] + u[3]*(1 + ^(u[3],2))*u[6] + ^(u[2],3)*(u[7] + ^(u[3],2)*u[7] - u[4] - u[5]) + u[2]*(^(1 + ^(u[3],2),2)*u[7] - u[4] - (1 + ^(u[3],2))*u[5]))/(tau*(1 + ^(u[3],2))*sqrt(1 + ^(u[2],2) + ^(u[3],2)))

    ,(dtp*u[1]*u[3]*(1 + ^(u[2],2) + ^(u[3],2)) + ^(u[3],3)*u[7] + u[2]*u[6] + u[3]*(u[7] + ^(u[2],2)*u[7] + u[4]))/(tau*sqrt(1 + ^(u[2],2) + ^(u[3],2)))

    ,(-2*(1 + ^(u[3],2))*sqrt(1 + ^(u[2],2) + ^(u[3],2))*visc)/(3*tau) + u[4]

    ,(4*sqrt(1 + ^(u[2],2) + ^(u[3],2))*visc + 3*tau*u[5])/(3*^(tau,3))

    ,(-2*u[2]*u[3]*sqrt(1 + ^(u[2],2) + ^(u[3],2))*visc)/(3*tau) + u[6]

    ,(sqrt(1 + ^(u[2],2) + ^(u[3],2))*zeta)/tau + u[7]

)

return (At,Ax,Ay,source)
end


